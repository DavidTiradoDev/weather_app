# CI/CD Pipeline para Weather App
# UbicaciÃ³n: .github/workflows/ci.yml (desde la RAÃZ del proyecto)

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: âœ¨ Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ” Analyze project source
        run: flutter analyze --fatal-infos

      - name: ğŸ¤– Generate mocks
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ§ª Run unit tests
        run: flutter test --coverage --test-randomize-ordering-seed random

      - name: ğŸ“Š Check test coverage
        uses: VeryGoodOpenSource/very_good_coverage@v2
        with:
          path: coverage/lcov.info
          min_coverage: 80
          exclude: |
            **/*.g.dart
            **/*.freezed.dart
            **/generated/**
            **/l10n/**

      - name: ğŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ“‹ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            test/

  integration_test:
    name: ğŸ”„ Integration Tests
    runs-on: macos-latest
    needs: [test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ¤– Generate mocks
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ“± Start iOS Simulator
        uses: futureware-tech/simulator-action@v2
        with:
          model: "iPhone 15"

      - name: ğŸ§ª Run integration tests
        run: flutter test integration_test/

      - name: ğŸ“‹ Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: integration_test/

  build_android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ¤– Generate mocks
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ—ï¸ Build Android APK
        run: flutter build apk --release

      - name: ğŸ“Š APK size check
        run: |
          APK_SIZE=$(stat -c%s build/app/outputs/flutter-apk/app-release.apk)
          echo "APK Size: $((APK_SIZE / 1024 / 1024)) MB"
          if [ $APK_SIZE -gt 52428800 ]; then # 50MB
            echo "âš ï¸ APK size exceeds 50MB"
          else
            echo "âœ… APK size is acceptable"
          fi

      - name: ğŸ“¦ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  build_ios:
    name: ğŸ Build iOS
    runs-on: macos-latest
    needs: [test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ¤– Generate mocks
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ—ï¸ Build iOS (no signing)
        run: flutter build ios --release --no-codesign

  security_scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ” Security audit
        run: |
          echo "ğŸ” Running security checks..."

          # Check for known vulnerabilities in dependencies
          flutter pub audit || echo "âš ï¸ Some vulnerabilities found"

          # Check for git dependencies (potential security risk)
          if grep -q "git:" pubspec.yaml; then
            echo "âš ï¸ Git dependencies found:"
            grep "git:" pubspec.yaml
          else
            echo "âœ… No git dependencies found"
          fi

          # Check for dev dependencies in main dependencies
          echo "ğŸ“‹ Checking dependency structure..."

      - name: ğŸ“‹ Generate security report
        run: |
          echo "# Security Report" > security_report.md
          echo "Generated on: $(date)" >> security_report.md
          echo "" >> security_report.md
          echo "## Dependencies" >> security_report.md
          flutter pub deps >> security_report.md

      - name: ğŸ“¦ Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security_report.md

  performance_analysis:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: "stable"

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ¤– Generate mocks
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ—ï¸ Build for performance analysis
        run: flutter build apk --profile

      - name: ğŸ“Š Analyze app size
        run: |
          echo "# Performance Report" > performance_report.md
          echo "Generated on: $(date)" >> performance_report.md
          echo "" >> performance_report.md
          echo "## App Size Analysis" >> performance_report.md

          if [ -f build/app/outputs/flutter-apk/app-profile.apk ]; then
            SIZE=$(stat -c%s build/app/outputs/flutter-apk/app-profile.apk)
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "Profile APK size: ${SIZE_MB} MB" >> performance_report.md
            
            if [ $SIZE_MB -lt 30 ]; then
              echo "âœ… Excellent app size" >> performance_report.md
            elif [ $SIZE_MB -lt 50 ]; then
              echo "âš ï¸ Good app size" >> performance_report.md
            else
              echo "âŒ Large app size - consider optimization" >> performance_report.md
            fi
          fi

          echo "" >> performance_report.md
          echo "## Code Metrics" >> performance_report.md
          find lib -name "*.dart" | wc -l | xargs echo "Dart files:" >> performance_report.md
          find test -name "*.dart" | wc -l | xargs echo "Test files:" >> performance_report.md

      - name: ğŸ“¦ Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance_report.md

  deploy_staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, integration_test, build_android]
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./

      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # AquÃ­ irÃ­an los comandos para desplegar a staging
          # Por ejemplo: Firebase App Distribution, TestFlight, etc.
          echo "âœ… Deployed to staging"

  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [test, integration_test, build_android, build_ios]
    if: always()

    steps:
      - name: ğŸ“¢ Notify success
        if: ${{ needs.test.result == 'success' && needs.build_android.result == 'success' }}
        run: |
          echo "âœ… All checks passed successfully!"
          echo "ğŸ§ª Tests: âœ…"
          echo "ğŸ¤– Android Build: âœ…"
          echo "ğŸ iOS Build: âœ…"

      - name: ğŸ“¢ Notify failure
        if: ${{ needs.test.result == 'failure' || needs.build_android.result == 'failure' }}
        run: |
          echo "âŒ Some checks failed:"
          echo "ğŸ§ª Tests: ${{ needs.test.result }}"
          echo "ğŸ¤– Android Build: ${{ needs.build_android.result }}"
          echo "ğŸ iOS Build: ${{ needs.build_ios.result }}"
